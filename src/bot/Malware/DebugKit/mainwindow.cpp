#include <functional>

#include <QVariant>

#include "../SharedKernel/Systems/process.h"
#include "../SharedKernel/Utilities/logging.h"
#include "mainwindow.h"
#include "ui_mainwindow.h"

#ifdef Q_OS_WIN
    #include "../SharedKernel/Systems/Windows/windowsinjector.h"
    #include "../SharedKernel/Systems/Windows/windowsprocessrepository.h"
#endif

MainWindow::MainWindow(QWidget *parent) :
    QMainWindow(parent),
    ui(new Ui::MainWindow),
    selectedProcess_(nullptr)
{
    ui->setupUi(this);
    utilities::Logging::subscribe([=](QString m) {this->writeLogging(m);});
    utilities::Logging::info("plop");

    loadSystemDependantRepositories();
    disableTitleBarOfDockPanels();
}

MainWindow::~MainWindow()
{
    delete ui;
    delete injector_;
    delete processRepo_;
    delete selectedProcess_;
}

void MainWindow::on_injectInProcessButton_clicked()
{
    if(selectedProcess_ != nullptr)
    {
        injector_->injectInProcess(*selectedProcess_, "Injector.dll");
    }
}

void MainWindow::on_processesCombo_currentIndexChanged(int selectedIndex)
{
    if(selectedIndex >= 0)
    {
        systems::Process selectedProcess = processRepo_->getProcessById(ui->processesCombo->itemData(selectedIndex).toInt());

        selectedProcess_ = new systems::Process(selectedProcess);
    }
}

void MainWindow::on_processesCombo_opened()
{
    ui->processesCombo->clear();

    std::vector<systems::Process> processes = processRepo_->getAllProcesses();

    for(int i = processes.size() - 1 ; i >= 0 ; i--)
    {
        ui->processesCombo->addItem(processes[i].name() + " (" + QString::number(processes[i].id()) + ")", QVariant::fromValue(processes[i].id()));
    }
}

void MainWindow::disableTitleBarOfDockPanels()
{
    QWidget* titleWidget = new QWidget(this);
    ui->menuDock->setTitleBarWidget(titleWidget);
}

void MainWindow::loadSystemDependantRepositories()
{
#ifdef Q_OS_WIN
    this->injector_ = new systems::windows::WindowsInjector;
    this->processRepo_ = new systems::windows::WindowsProcessRepository;
#endif
}

void MainWindow::writeLogging(QString message)
{
    ui->textLogging->setPlainText(ui->textLogging->toPlainText() + message + "\n");
}
