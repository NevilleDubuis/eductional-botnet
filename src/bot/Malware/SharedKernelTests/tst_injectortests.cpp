#include <QString>
#include <QtTest>

#include <Windows.h>

#include "../SharedKernel/Systems/process.h"
#include "tst_injectortests.h"
#include "utilities.h"

void InjectorTests::initTestCase()
{
#ifdef Q_OS_WIN
    this->injector_ = new systems::windows::WindowsInjector();
    this->processRepo_ = new systems::windows::WindowsProcessRepository();
#endif
}

void InjectorTests::cleanupTestCase()
{
    delete this->injector_;
    delete this->processRepo_;
}

void InjectorTests::testInjectInProcess_InjectInItself()
{
    // Arrange
    auto processes = this->processRepo_->getAllProcesses();
    systems::Process* itself = nullptr;

    // Act & Assert
    for(auto& p : processes)
    {
        if(p.name() == "tst_processrepositorytests.exe")
        {
            itself = &p;
        }
    }

    if(itself == nullptr)
    {
        QFAIL("The process of the unit test is not found.");
    }

    this->injector_->injectInProcess(*itself, "Injector.dll");

    // Assert
    Utilities::sleep(2000); // Wait for the injection
}
