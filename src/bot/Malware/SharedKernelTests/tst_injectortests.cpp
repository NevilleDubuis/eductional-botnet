#include <QString>
#include <QtTest>

#include <Windows.h>

#include "../SharedKernel/Systems/process.h"
#include "tst_injectortests.h"
#include "utilities.h"

void InjectorTests::initTestCase()
{
#ifdef Q_OS_WIN
    this->injector_ = new systems::windows::WindowsInjector();
    this->moduleRepo_ = new systems::windows::WindowsModuleRepository();
    this->processRepo_ = new systems::windows::WindowsProcessRepository();
#endif
}

void InjectorTests::cleanupTestCase()
{
    delete this->injector_;
    delete this->moduleRepo_;
    delete this->processRepo_;
}

void InjectorTests::testInjectInProcess_InjectInItself()
{
    // Arrange
    auto currentProcess = this->processRepo_->getCurrentProcess();
    QString libPath = "Injector.dll";

    // Act
    this->injector_->injectInProcess(currentProcess, libPath);
    Utilities::sleep(2000); // Wait for the injection

    // Assert
    this->moduleRepo_->isModuleLoaded(currentProcess, libPath);
}
