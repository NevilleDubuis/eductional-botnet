#include <QByteArray>
#include <QJsonDocument>
#include <QNetworkRequest>
#include <Windows.h>

#include "../Messages/Server/servermessage.h"
#include "httpserveradapter.h"

using namespace network::messages::client;
using namespace network::messages::server;

namespace network { namespace http
{
    HttpServerAdapter::HttpServerAdapter()
    {
        connect(&network_, SIGNAL(finished(QNetworkReply*)), this, SLOT(onRequestFinished(QNetworkReply*)));
    }

    void HttpServerAdapter::send(ClientMessage& message)
    {
        QNetworkRequest request(apiUrl_);
        QByteArray data = QJsonDocument(message.toJson()).toJson();

        QNetworkReply* reply = network_.post(request, data);
    }

    void HttpServerAdapter::onRequestFinished(QNetworkReply *reply)
    {
        emit receive(ServerMessage(ServerOpcode::AskInformation));

        // Mark the reply as ready to be deleted
        reply->deleteLater();
    }
}}
