#ifndef HTTPSERVERADAPTER_H
#define HTTPSERVERADAPTER_H

#include <memory>
#include <functional>

#include <QJsonObject>
#include <QMap>
#include <QNetworkAccessManager>
#include <QNetworkReply>

#include "../Messages/Server/servermessage.h"
#include "../serveradapter.h"

namespace network { namespace http
{
    class HttpServerAdapter : public ServerAdapter
    {
        Q_OBJECT

    private:
        static QMap<ServerOpcode, std::function<std::shared_ptr<network::messages::server::ServerMessage>(QJsonObject&)>> serverMapper_;
        const QUrl apiUrl_ = "http://educational-botnet.herokuapp.com/api/bots";
        QNetworkAccessManager network_;

        std::unique_ptr<messages::server::ServerMessage> createMessageFromReply(QNetworkReply* reply);
        void handleError(QNetworkReply::NetworkError error);

    public:
        HttpServerAdapter();
        void send(messages::client::ClientMessage& message) override;

    protected slots:
        virtual void onRequestFinished(QNetworkReply* reply);
    };
}}

#endif // HTTPSERVERADAPTER_H
